name: Documentation

on:
  release:
    types:
      - published
      - created
  push:
    branches:
      - main
    paths:
      - 'Sources/**'
      - '.github/workflows/documentation.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15
    permissions:
      contents: write
    steps:
      - name: Select Xcode 16.4
        run: sudo xcode-select -s /Applications/Xcode_16.4.app

      - name: Checkout Package
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Checkout gh-pages Branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: docs-out

      - name: Build documentation
        run: |
          rm -rf docs-out/.git;
          rm -rf docs-out/main;
          
          echo "ğŸ” Found tags: $(git tag | tr '\n' ' ')";
          echo "ğŸ“¦ Repository: ${{ github.repository }}";

          for tag in $(echo "main"; git tag);
          do
              echo "";
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
              echo "â³ Generating documentation for $tag";
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";

              if [ -d "docs-out/$tag" ] 
              then 
                  echo "âœ… Documentation for $tag already exists - skipping";
              else 
                  echo "ğŸ“ Checking out $tag...";
                  git checkout "$tag";

                  echo "ğŸ§¹ Cleaning build directory...";
                  rm -rf .build;

                  echo "ğŸ“ Creating output directory...";
                  mkdir -p "docs-out/$tag";

                  echo "ğŸ“¦ Resolving packages...";
                  swift package resolve;

                  echo "ğŸ”¨ Building documentation...";
                  if xcodebuild docbuild -scheme AsyncLifetime \
                      -destination 'generic/platform=iOS' \
                      OTHER_DOCC_FLAGS="--transform-for-static-hosting --output-path docs-out/$tag --hosting-base-path /AsyncLifetime/$tag"; then
                      echo "âœ… Documentation successfully generated for $tag";
                      echo "ğŸ”— Will be available at: https://${{ github.repository_owner }}.github.io/AsyncLifetime/$tag/documentation/asynclifetime/";
                  else
                      echo "âš ï¸ Documentation generation failed for $tag - skipping";
                  fi
              fi;
          done
          
          echo "";
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
          echo "ğŸ“Š Documentation Build Summary";
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
          echo "Generated documentation for:";
          ls -1 docs-out/ | grep -v "\.git" || echo "No documentation generated";

      - name: Fix permissions
        run: 'sudo chown -R $USER docs-out'
        
      - name: Publish documentation to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4.5.0
        with:
          branch: gh-pages
          folder: docs-out
          single-commit: true
